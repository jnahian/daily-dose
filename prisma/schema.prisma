generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id                 String               @id @default(uuid())
  name               String               @unique
  slackWorkspaceId   String?              @unique @map("slack_workspace_id")
  slackWorkspaceName String?              @map("slack_workspace_name")
  defaultTimezone    String               @default("America/New_York") @map("default_timezone")
  settings           Json                 @default("{}")
  isActive           Boolean              @default(true) @map("is_active")
  createdAt          DateTime             @default(now()) @map("created_at")
  updatedAt          DateTime             @updatedAt @map("updated_at")
  holidays           Holiday[]
  members            OrganizationMember[]
  teams              Team[]

  @@map("organizations")
}

model Team {
  id               String            @id @default(uuid())
  organizationId   String            @map("organization_id")
  name             String
  slackChannelId   String            @unique @map("slack_channel_id")
  standupTime      String            @map("standup_time")
  postingTime      String            @map("posting_time")
  timezone         String            @default("America/New_York")
  isActive         Boolean           @default(true) @map("is_active")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")
  standupPosts     StandupPost[]
  standupResponses StandupResponse[]
  members          TeamMember[]
  organization     Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("teams")
}

model User {
  id               String               @id @default(uuid())
  slackUserId      String               @unique @map("slack_user_id")
  email            String?
  name             String?
  timezone         String               @default("America/New_York")
  workDays         Json?                @map("work_days")
  createdAt        DateTime             @default(now()) @map("created_at")
  username         String?
  leaves           Leave[]
  organizations    OrganizationMember[]
  sessions         sessions[]
  standupResponses StandupResponse[]
  super_admins     super_admins?
  teams            TeamMember[]

  @@map("users")
}

model OrganizationMember {
  id             String       @id @default(uuid())
  organizationId String       @map("organization_id")
  userId         String       @map("user_id")
  role           OrgRole      @default(MEMBER)
  isActive       Boolean      @default(true) @map("is_active")
  joinedAt       DateTime     @default(now()) @map("joined_at")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@map("organization_members")
}

model TeamMember {
  id                   String   @id @default(uuid())
  teamId               String   @map("team_id")
  userId               String   @map("user_id")
  role                 TeamRole @default(MEMBER)
  isActive             Boolean  @default(true) @map("is_active")
  joinedAt             DateTime @default(now()) @map("joined_at")
  receiveNotifications Boolean  @default(true) @map("receive_notifications")
  hideFromNotResponded Boolean  @default(false) @map("hide_from_not_responded")
  team                 Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@map("team_members")
}

model Leave {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  startDate DateTime @map("start_date") @db.Date
  endDate   DateTime @map("end_date") @db.Date
  reason    String?  @db.VarChar(500)
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, startDate, endDate])
  @@map("leaves")
}

model StandupResponse {
  id             String   @id @default(uuid())
  teamId         String   @map("team_id")
  userId         String   @map("user_id")
  standupDate    DateTime @map("standup_date") @db.Date
  yesterdayTasks String?  @map("yesterday_tasks")
  todayTasks     String?  @map("today_tasks")
  blockers       String?
  hasBlockers    Boolean  @default(false) @map("has_blockers")
  submittedAt    DateTime @default(now()) @map("submitted_at")
  isLate         Boolean  @default(false) @map("is_late")
  team           Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId, standupDate])
  @@index([standupDate])
  @@map("standup_responses")
}

model StandupPost {
  id             String   @id @default(uuid())
  teamId         String   @map("team_id")
  standupDate    DateTime @map("standup_date") @db.Date
  slackMessageTs String?  @map("slack_message_ts")
  channelId      String?  @map("channel_id")
  postedAt       DateTime @default(now()) @map("posted_at")
  team           Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, standupDate])
  @@map("standup_posts")
}

model Holiday {
  id              String       @id @default(uuid())
  date            DateTime     @db.Date
  name            String       @db.VarChar(255)
  createdAt       DateTime     @default(now()) @map("created_at")
  organization_id String
  updated_at      DateTime
  description     String?
  organizations   Organization @relation(fields: [organization_id], references: [id], onDelete: Cascade)

  @@unique([organization_id, date])
  @@index([date])
  @@index([organization_id])
  @@map("holidays")
}

model sessions {
  id         String   @id
  user_id    String
  token      String   @unique
  expires_at DateTime
  ip_address String?
  user_agent String?
  created_at DateTime @default(now())
  users      User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([expires_at])
  @@index([token])
  @@index([user_id])
}

model super_admins {
  id         String    @id
  user_id    String    @unique
  granted_by String?
  granted_at DateTime  @default(now())
  revoked_at DateTime?
  notes      String?
  users      User      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
}

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
}

enum TeamRole {
  ADMIN
  MEMBER
}
